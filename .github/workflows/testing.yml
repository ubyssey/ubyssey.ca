name: Cross-browser Testing

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]

jobs:
  test_desktop_browsers:
    runs-on: ${{ matrix.browser == 'safari' && 'macos-latest' || 'ubuntu-latest' }}
    strategy:
      matrix:
        browser: [chrome, firefox, edge, safari]
        python-version: [ 3.8 ]

    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python packages and dependencies
        run: |
          pip install -r requirements-prd.txt --use-pep517 
          pip install requests --upgrade
      
      - name: Set up Node.js environment
        uses: actions/setup-node@v2.1.4
        with:
          node-version: 14.x  
      
      - name: Run gulp to ready frontend static files for production
        run: |
          cd ubyssey/static_src
          npm install -g gulp
          npm install
          npm ddp
          gulp build
          rm -rf node_modules
          cd ../../
      
      - name: Collect static files
        run: |
          export DJANGO_SETTINGS_MODULE="config.settings.development"
          python manage.py collectstatic --noinput
          rm -rf .git/ ubyssey/static_src/
      
      - name: Print current working directory
        run: pwd
      
      - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl unzip
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
      
      - name: Install Edge
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
        sudo install -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/
        sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
        sudo rm microsoft.gpg
        sudo apt-get update
        sudo apt-get install -y microsoft-edge-stable
      
      - name: Install Firefox
      run: |
        sudo apt-get update
        sudo apt-get install -y firefox

      # Run tests on different browsers
      - name: Run tests on ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            python ubyssey.ca/tests/test_usability.py chrome
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            python ubyssey.ca/tests/test_usability.py firefox
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            python ubyssey.ca/tests/test_usability.py edge
          elif [ "${{ matrix.browser }}" = "safari" ]; then
            python ubyssey.ca/tests/test_usability.py safari
          fi
